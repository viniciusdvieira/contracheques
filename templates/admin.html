{% extends "base.html" %}
{% block content %}
<section class="card-elevated admin-card">
  <div class="admin-header">
    <div class="admin-title">
      <div class="admin-icon">ADM</div>
      <div>
        <h2 class="page-title">Administração</h2>
        <p class="muted-text">Gerencie funcionários e contracheques.</p>
      </div>
    </div>
    <button class="btn btn-primary" id="btn-new-user">Novo Funcionário</button>
  </div>

  <div class="admin-stats">
    <div class="admin-stat card-elevated">
      <p class="stat-label">Total de Funcionários</p>
      <p class="stat-value" id="stat-total">0</p>
    </div>
    <div class="admin-stat card-elevated">
      <p class="stat-label">Com Contracheque</p>
      <p class="stat-value stat-success" id="stat-issued">0</p>
    </div>
    <div class="admin-stat card-elevated">
      <p class="stat-label">Sem Contracheque</p>
      <p class="stat-value stat-warning" id="stat-pending">0</p>
    </div>
  </div>

  <div class="admin-search">
    <input id="searchInput" type="text" placeholder="Pesquisar por nome, matrícula, CPF ou setor...">
  </div>

  <div class="admin-table card-elevated">
    <table class="table">
      <thead>
        <tr>
          <th>Funcionário</th>
          <th class="hide-sm">Setor</th>
          <th class="hide-xs">Status</th>
          <th class="text-right">Ações</th>
        </tr>
      </thead>
      <tbody id="employeesBody">
        <tr>
          <td colspan="4" class="text-center muted-text">Carregando...</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<div class="admin-toast" id="adminToast"></div>

<!-- Modal: Create/Edit User -->
<div class="modal" id="userModal" aria-hidden="true">
  <div class="modal-backdrop" data-close="userModal"></div>
  <div class="modal-card">
    <div class="modal-header">
      <h3 id="userModalTitle">Novo Funcionário</h3>
      <button class="modal-close" data-close="userModal">x</button>
    </div>
    <div class="modal-body">
      <div class="form">
        <div class="field">
          <label for="userNome">Nome completo *</label>
          <input id="userNome" type="text" placeholder="Nome completo">
        </div>
        <div class="field" id="userMatriculaField">
          <label for="userMatricula">Matrícula *</label>
          <input id="userMatricula" type="text" placeholder="0000000">
        </div>
        <div class="field">
          <label for="userEmail">E-mail</label>
          <input id="userEmail" type="email" placeholder="email@empresa.com">
        </div>
        <div class="field">
          <label for="userSenha">Senha inicial</label>
          <input id="userSenha" type="password" placeholder="Senha temporária">
          <p class="hint-text" id="passwordHint">O funcionário deverá alterar no primeiro acesso.</p>
        </div>
        <div class="form-grid">
          <div class="field">
            <label for="userCpf">CPF</label>
            <input id="userCpf" type="text" placeholder="000.000.000-00">
          </div>
          <div class="field">
            <label for="userCargo">Cargo</label>
            <input id="userCargo" type="text" placeholder="Cargo">
          </div>
        </div>
        <div class="field">
          <label for="userDepto">Departamento / Setor</label>
          <input id="userDepto" type="text" placeholder="Ex: Financeiro, TI, RH...">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" data-close="userModal">Cancelar</button>
      <button class="btn btn-primary" id="saveUserBtn">Salvar</button>
    </div>
  </div>
</div>

<!-- Modal: Upload Payslip -->
<div class="modal" id="uploadModal" aria-hidden="true">
  <div class="modal-backdrop" data-close="uploadModal"></div>
  <div class="modal-card">
    <div class="modal-header">
      <h3>Enviar Contracheque</h3>
      <button class="modal-close" data-close="uploadModal">x</button>
    </div>
    <div class="modal-body">
      <p class="muted-text">Funcionário: <strong id="uploadEmployeeName"></strong></p>
      <div class="form-grid">
        <div class="field">
          <label for="uploadMonth">Mês</label>
          <select id="uploadMonth"></select>
        </div>
        <div class="field">
          <label for="uploadYear">Ano</label>
          <select id="uploadYear"></select>
        </div>
      </div>
      <div class="field">
        <label>Arquivo PDF</label>
        <div class="dropzone" id="dropzone">
          <span id="dropzoneText">Clique para selecionar o arquivo PDF</span>
          <input id="uploadFile" type="file" accept=".pdf,application/pdf">
        </div>
        <p class="hint-text" id="uploadFileName"></p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" data-close="uploadModal">Cancelar</button>
      <button class="btn btn-primary" id="sendUploadBtn">Enviar Contracheque</button>
    </div>
  </div>
</div>

<!-- Modal: View Payslips -->
<div class="modal" id="viewModal" aria-hidden="true">
  <div class="modal-backdrop" data-close="viewModal"></div>
  <div class="modal-card">
    <div class="modal-header">
      <h3 id="viewModalTitle">Contracheques</h3>
      <button class="modal-close" data-close="viewModal">x</button>
    </div>
    <div class="modal-body">
      <div class="admin-table card-elevated compact">
        <table class="table">
          <thead>
            <tr>
              <th>Competência</th>
              <th>Visualizado</th>
              <th>Baixado</th>
            </tr>
          </thead>
          <tbody id="viewPayslipsBody">
            <tr>
              <td colspan="3" class="text-center muted-text">Carregando...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" data-close="viewModal">Fechar</button>
    </div>
  </div>
</div>

<script>
const state = {
  employees: [],
  editingId: null,
  uploadUserId: null,
};

const MONTHS = [
  { value: "01", label: "Janeiro" }, { value: "02", label: "Fevereiro" },
  { value: "03", label: "Março" }, { value: "04", label: "Abril" },
  { value: "05", label: "Maio" }, { value: "06", label: "Junho" },
  { value: "07", label: "Julho" }, { value: "08", label: "Agosto" },
  { value: "09", label: "Setembro" }, { value: "10", label: "Outubro" },
  { value: "11", label: "Novembro" }, { value: "12", label: "Dezembro" },
];

const toastEl = document.getElementById("adminToast");
function showToast(message, type = "success") {
  toastEl.textContent = message;
  toastEl.className = `admin-toast show ${type}`;
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => {
    toastEl.className = "admin-toast";
  }, 3200);
}

function openModal(id) {
  document.getElementById(id).classList.add("is-open");
}

function closeModal(id) {
  document.getElementById(id).classList.remove("is-open");
}

document.querySelectorAll("[data-close]").forEach(btn => {
  btn.addEventListener("click", () => closeModal(btn.dataset.close));
});

function monthLabel(ref) {
  const parts = (ref || "").split("-");
  if (parts.length < 2) return ref || "-";
  const year = parts[0];
  const month = parts[1];
  const found = MONTHS.find(m => m.value === month);
  return `${found ? found.label : month} / ${year}`;
}

function renderStats(list) {
  const total = list.length;
  const issued = list.filter(e => (e.payslip_count || 0) > 0).length;
  document.getElementById("stat-total").textContent = total;
  document.getElementById("stat-issued").textContent = issued;
  document.getElementById("stat-pending").textContent = total - issued;
}

function renderTable() {
  const body = document.getElementById("employeesBody");
  const query = document.getElementById("searchInput").value.toLowerCase().trim();
  const filtered = state.employees.filter(e => {
    const target = [
      e.nome || "",
      e.matricula || "",
      e.cpf || "",
      e.department || ""
    ].join(" ").toLowerCase();
    return target.includes(query);
  });

  renderStats(state.employees);

  if (filtered.length === 0) {
    body.innerHTML = `<tr><td colspan="4" class="text-center muted-text">Nenhum funcionário encontrado.</td></tr>`;
    return;
  }

  body.innerHTML = filtered.map(emp => {
    const status = (emp.payslip_count || 0) > 0
      ? `<span class="status status-issued">${emp.payslip_count} emitido(s)</span>`
      : `<span class="status status-pending">Nenhum</span>`;
    return `
      <tr class="payslip-row">
        <td>
          <div class="emp-name">${emp.nome || "Sem nome"}</div>
          <div class="emp-sub">Matrícula: ${emp.matricula || "-"}</div>
          ${emp.position ? `<div class="emp-sub">${emp.position}</div>` : ""}
          ${emp.cpf ? `<div class="emp-sub">CPF: ${emp.cpf}</div>` : ""}
        </td>
        <td class="hide-sm">${emp.department || "—"}</td>
        <td class="hide-xs">${status}</td>
        <td class="text-right">
          <div class="action-group">
            <button class="icon-btn" data-action="view" data-id="${emp.id}">Ver</button>
            <button class="icon-btn" data-action="edit" data-id="${emp.id}">Editar</button>
            <button class="btn btn-primary btn-sm" data-action="upload" data-id="${emp.id}">Enviar</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");
}

async function loadEmployees() {
  const res = await fetch("/api/admin/employees");
  const data = await res.json();
  if (!data.ok) {
    showToast(data.error || "Erro ao carregar dados", "error");
    return;
  }
  state.employees = data.employees || [];
  renderTable();
}

document.getElementById("searchInput").addEventListener("input", renderTable);
document.getElementById("btn-new-user").addEventListener("click", () => openUserModal());

document.getElementById("employeesBody").addEventListener("click", (event) => {
  const btn = event.target.closest("button[data-action]");
  if (!btn) return;
  const id = Number(btn.dataset.id);
  const action = btn.dataset.action;
  const emp = state.employees.find(e => e.id === id);
  if (!emp) return;
  if (action === "edit") openUserModal(emp);
  if (action === "upload") openUploadModal(emp);
  if (action === "view") openViewModal(emp);
});

function openUserModal(emp) {
  state.editingId = emp ? emp.id : null;
  document.getElementById("userModalTitle").textContent = emp ? "Editar Funcionário" : "Novo Funcionário";
  document.getElementById("userNome").value = emp?.nome || "";
  document.getElementById("userMatricula").value = emp?.matricula || "";
  document.getElementById("userMatricula").disabled = !!emp;
  document.getElementById("userMatriculaField").style.display = emp ? "none" : "block";
  document.getElementById("userEmail").value = emp?.email || "";
  document.getElementById("userSenha").value = "";
  document.getElementById("userCpf").value = emp?.cpf || "";
  document.getElementById("userCargo").value = emp?.position || "";
  document.getElementById("userDepto").value = emp?.department || "";
  document.getElementById("passwordHint").textContent = emp
    ? "Deixe em branco para não alterar a senha."
    : "O funcionário deverá alterar no primeiro acesso.";
  openModal("userModal");
}

async function saveUser() {
  const payload = {
    nome: document.getElementById("userNome").value.trim(),
    matricula: document.getElementById("userMatricula").value.trim(),
    email: document.getElementById("userEmail").value.trim(),
    password: document.getElementById("userSenha").value,
    cpf: document.getElementById("userCpf").value.trim(),
    position: document.getElementById("userCargo").value.trim(),
    department: document.getElementById("userDepto").value.trim()
  };

  let res;
  if (state.editingId) {
    if (!payload.nome) {
      showToast("Informe o nome.", "error");
      return;
    }
    res = await fetch(`/api/admin/employees/${state.editingId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
  } else {
    if (!payload.nome || !payload.matricula) {
      showToast("Informe nome e matrícula.", "error");
      return;
    }
    if (!payload.password) {
      showToast("Informe a senha inicial.", "error");
      return;
    }
    res = await fetch("/api/admin/employees", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
  }

  const data = await res.json();
  if (!data.ok) {
    showToast(data.error || "Erro ao salvar", "error");
    return;
  }
  closeModal("userModal");
  showToast("Funcionário salvo com sucesso!");
  await loadEmployees();
}

document.getElementById("saveUserBtn").addEventListener("click", saveUser);

function openUploadModal(emp) {
  state.uploadUserId = emp.id;
  document.getElementById("uploadEmployeeName").textContent = emp.nome || emp.matricula;
  document.getElementById("uploadFile").value = "";
  document.getElementById("uploadFileName").textContent = "";
  openModal("uploadModal");
}

async function sendUpload() {
  const fileInput = document.getElementById("uploadFile");
  const file = fileInput.files[0];
  if (!file) {
    showToast("Selecione um PDF.", "error");
    return;
  }
  const month = document.getElementById("uploadMonth").value;
  const year = document.getElementById("uploadYear").value;

  const form = new FormData();
  form.append("user_id", String(state.uploadUserId));
  form.append("ref_month", month);
  form.append("ref_year", year);
  form.append("file", file);

  const res = await fetch("/api/admin/payslips/upload", {
    method: "POST",
    body: form
  });
  const data = await res.json();
  if (!data.ok) {
    showToast(data.error || "Erro ao enviar", "error");
    return;
  }
  closeModal("uploadModal");
  showToast("Contracheque enviado com sucesso!");
  await loadEmployees();
}

document.getElementById("sendUploadBtn").addEventListener("click", sendUpload);

document.getElementById("uploadFile").addEventListener("change", (e) => {
  const file = e.target.files[0];
  document.getElementById("uploadFileName").textContent = file ? file.name : "";
});

document.getElementById("dropzone").addEventListener("click", () => {
  document.getElementById("uploadFile").click();
});

async function openViewModal(emp) {
  document.getElementById("viewModalTitle").textContent = `Contracheques — ${emp.nome || emp.matricula}`;
  const body = document.getElementById("viewPayslipsBody");
  body.innerHTML = `<tr><td colspan="3" class="text-center muted-text">Carregando...</td></tr>`;
  openModal("viewModal");

  const res = await fetch(`/api/admin/payslips?user_id=${emp.id}`);
  const data = await res.json();
  if (!data.ok) {
    body.innerHTML = `<tr><td colspan="3" class="text-center muted-text">Erro ao carregar.</td></tr>`;
    return;
  }
  const list = data.payslips || [];
  if (list.length === 0) {
    body.innerHTML = `<tr><td colspan="3" class="text-center muted-text">Nenhum contracheque emitido.</td></tr>`;
    return;
  }
  body.innerHTML = list.map(p => `
    <tr>
      <td>${monthLabel(p.referencia || "")}</td>
      <td>${p.viewed_at ? '<span class="status status-issued">Sim</span>' : '<span class="muted-text">Não</span>'}</td>
      <td>${p.downloaded_at ? '<span class="status status-issued">Sim</span>' : '<span class="muted-text">Não</span>'}</td>
    </tr>
  `).join("");
}

function buildSelects() {
  const monthSelect = document.getElementById("uploadMonth");
  monthSelect.innerHTML = MONTHS.map(m => `<option value="${m.value}">${m.label}</option>`).join("");
  const yearSelect = document.getElementById("uploadYear");
  const currentYear = new Date().getFullYear();
  const years = Array.from({ length: 5 }, (_, i) => String(currentYear - i));
  yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");
  monthSelect.value = String(new Date().getMonth() + 1).padStart(2, "0");
  yearSelect.value = String(currentYear);
}

buildSelects();
loadEmployees();
</script>
{% endblock %}
